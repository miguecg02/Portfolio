<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMChess3D - Ajedrez 3D</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♟️</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a3d7c 0%, #2a5ca0 50%, #3fb8af 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; align-items: center; gap: 25px; }
        .back-button { display: inline-flex; align-items: center; padding: 12px 24px; background-color: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; align-self: flex-start; }
        .back-button:hover { background-color: white; color: #1a3d7c; transform: translateY(-2px); }
        .header { margin-bottom: 10px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.2rem; opacity: 0.9; margin-bottom: 30px; }
        .game-container { width: 100%; height: 70vh; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin: 20px 0; position: relative; }
        #chessCanvas { width: 100%; height: 100%; display: block; }
        .instructions { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; width: 100%; text-align: left; margin: 20px 0; }
        .instructions h3 { margin-bottom: 15px; font-size: 1.4rem; text-align: center; }
        .instructions ul { list-style-type: none; }
        .instructions li { margin-bottom: 10px; padding-left: 25px; position: relative; }
        .instructions li:before { content: "•"; color: #3fb8af; font-weight: bold; position: absolute; left: 0; }
        .loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; background: rgba(0,0,0,0.8); z-index: 10; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 5px solid #3fb8af; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .error-message { color: #ff6b6b; text-align:center; padding:20px; display:none; }
        .retry-button { margin-top: 15px; padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .retry-button:hover { background: rgba(255,255,255,0.3); }
        .debug-panel { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; z-index: 1000; font-size: 12px; border-radius: 5px; max-width: 300px; display: none; }
        .debug-toggle { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; z-index: 1001; }
        .progress-bar { width: 80%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress { height: 100%; background: #3fb8af; width: 0%; transition: width 0.3s ease; }
        .server-info { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; max-width: 500px; }
        .server-info h4 { margin-bottom: 10px; text-align:center; }
        .code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; }
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .subtitle { font-size: 1rem; }
            .game-container { height: 50vh; }
            .debug-panel { top: 50px; right: 10px; max-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">← Volver al Portfolio</a>

        <div class="header">
            <h1>TMChess3D - Ajedrez en 3D</h1>
            <p class="subtitle">Una experiencia de ajedrez inmersiva con gráficos 3D</p>
        </div>

        <div class="game-container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div id="loading-text">Cargando ajedrez 3D...</div>
                <div id="loading-details" style="margin-top: 10px; font-size: 12px;"></div>
                <div class="progress-bar">
                    <div id="progress-bar-inner" class="progress"></div>
                </div>
            </div>
            <canvas id="chessCanvas"></canvas>
            <div id="error" class="error-message">
                <p>No se pudo cargar el juego. Esto puede deberse a:</p>
                <ul>
                    <li>Tu navegador no soporta WebGL</li>
                    <li>Problemas al cargar los recursos del juego</li>
                    <li>El servidor local no está funcionando correctamente</li>
                </ul>
                <div class="server-info">
                    <h4>Para solucionarlo:</h4>
                    <ol>
                        <li>Abre una terminal/consola en la carpeta del proyecto</li>
                        <li>Ejecuta el siguiente comando:</li>
                        <div class="code">python server-launcher.py</div>
                        <li>Accede a la aplicación mediante la URL que se muestra (normalmente http://localhost:8000/chess.html)</li>
                    </ol>
                </div>
                <div id="error-details" style="margin-top: 15px; text-align: left; font-size: 14px;"></div>
                <button class="retry-button" onclick="retryLoad()">Reintentar</button>
            </div>
        </div>

        <div class="instructions">
            <h3>Instrucciones:</h3>
            <ul>
                <li>Haz clic en una pieza para seleccionarla</li>
                <li>La torre y el peón tienen animaciones al capturar</li>
                <li>Las casillas verdes indican movimientos válidos</li>
                <li>Usa la rueda del mouse para acercar/alejar</li>
                <li>Haz clic y arrastra para rotar la cámara</li>
                <li>Presiona 'C' para cambiar la vista de la cámara</li>
                <li>Presiona 'S' para reiniciar el juego</li>
                <li>Disfruta de la experiencia 3D inmersiva</li>
            </ul>
        </div>
    </div>

    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    <div class="debug-panel" id="debug-panel">
        <h4>Estado de carga:</h4>
        <div id="debug-info"></div>
    </div>

    <!-- SCRIPT PRINCIPAL (MODIFICADO) -->
    <script type="module">
        // --- Estado y utilidades ---
        const loadStatus = {
            three: false,
            tween: false,
            chessGame: false,
            board: false,
            pieces: false,
            abstractPiece: false,
            materialSets: false,
            scene: false
        };

        let totalModules = Object.keys(loadStatus).length;
        let loadedModules = 0;

        function updateProgress() {
            loadedModules++;
            const progress = (loadedModules / totalModules) * 100;
            const el = document.getElementById('progress-bar-inner');
            if (el) el.style.width = `${progress}%`;
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            if (!debugInfo) return;
            debugInfo.innerHTML = `
                <div>WebGL: ${webglAvailable() ? '✅' : '❌'}</div>
                <div>Canvas: ${document.getElementById('chessCanvas') ? '✅' : '❌'}</div>
                <div>THREE: ${loadStatus.three ? '✅' : '❌'}</div>
                <div>TWEEN: ${loadStatus.tween ? '✅' : '❌'}</div>
                <div>ChessGame: ${loadStatus.chessGame ? '✅' : '❌'}</div>
                <div>Board: ${loadStatus.board ? '✅' : '❌'}</div>
                <div>Pieces: ${loadStatus.pieces ? '✅' : '❌'}</div>
                <div>AbstractPiece: ${loadStatus.abstractPiece ? '✅' : '❌'}</div>
                <div>MaterialSets: ${loadStatus.materialSets ? '✅' : '❌'}</div>
                <div>Scene: ${loadStatus.scene ? '✅' : '❌'}</div>
            `;
        }

        function updateLoadingText(text) {
            const loadingDetails = document.getElementById('loading-details');
            if (loadingDetails) loadingDetails.textContent = text;
            const loadingText = document.getElementById('loading-text');
            if (loadingText) loadingText.textContent = text;
            console.log('[Loading] ' + text);
            updateDebugInfo();
        }

        // --- loadModule robusto: normaliza rutas y reintenta ---
        async function loadModule(modulePath, moduleName, maxRetries = 3) {
            updateLoadingText(`Cargando ${moduleName}...`);

            // Construir candidatos razonables para la ruta (relativa, con ./, absoluta)
            const candidates = new Set();

            // Si ya parece URL absoluta (http/https or startsWith('/')), añadir tal cual
            if (/^(https?:)?\/\//.test(modulePath) || modulePath.startsWith('/')) {
                candidates.add(modulePath);
            } else {
                // Añadir versión tal cual, con ./ y versión absoluta basada en location.href
                candidates.add(modulePath);
                candidates.add('./' + modulePath);
                try {
                    candidates.add(new URL(modulePath, location.href).href);
                    candidates.add(new URL('./' + modulePath, location.href).href);
                } catch (e) {
                    // ignore si new URL lanza error (raro)
                }
            }

            let lastError = null;
            for (const candidate of candidates) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`Intentando importar ${moduleName} desde: ${candidate} (intento ${attempt})`);
                        const module = await import(candidate);
                        console.log(`${moduleName} cargado desde: ${candidate}`);
                        return module;
                    } catch (err) {
                        lastError = err;
                        console.warn(`Fallo al importar ${moduleName} desde ${candidate} (intento ${attempt}):`, err);
                        updateLoadingText(`Fallo ${moduleName} intento ${attempt}`);
                        // Espera exponencial corta antes de reintentar
                        await new Promise(res => setTimeout(res, 400 * attempt));
                    }
                }
            }

            throw new Error(`No se pudo cargar ${moduleName}. Último error: ${lastError && lastError.message}`);
        }

        // --- Cargar piezas individualmente (usa URLs absolutas con new URL) ---
        async function loadPiecesIndividually() {
            updateLoadingText("Cargando piezas individualmente...");

            // Lista de piezas
            const pieceFiles = ['Pawn.js', 'King.js', 'Queen.js', 'Knight.js', 'Rook.js', 'Bishop.js'];
            window.Pieces = {};

            // Primero cargar AbstractPiece
            try {
                const absUrl = new URL('./TMChess3D/Objects/Pieces/AbstractPiece.js', location.href).href;
                updateLoadingText(`Cargando AbstractPiece desde: ${absUrl}`);
                const AbsModule = await loadModule(absUrl, 'AbstractPiece');
                window.AbstractPiece = AbsModule.AbstractPiece || AbsModule.default || AbsModule;
                loadStatus.abstractPiece = true;
                updateProgress();
                console.log('AbstractPiece cargado correctamente');
            } catch (e) {
                console.error('Error al cargar AbstractPiece:', e);
                throw new Error(`AbstractPiece no se pudo cargar: ${e.message}`);
            }

            // Luego cargar cada pieza
            for (const file of pieceFiles) {
                const pieceName = file.replace('.js', '');
                const pieceUrl = new URL(`./TMChess3D/Objects/Pieces/${file}`, location.href).href;

                updateLoadingText(`Cargando ${pieceName} desde: ${pieceUrl}`);

                try {
                    const module = await loadModule(pieceUrl, pieceName);

                    // Manejar diferentes formas de exportación
                    if (module[pieceName]) {
                        window.Pieces[pieceName] = module[pieceName];
                    } else if (module.default) {
                        window.Pieces[pieceName] = module.default;
                    } else {
                        window.Pieces[pieceName] = module;
                    }

                    console.log(`${pieceName} cargado correctamente`);
                    updateProgress();
                } catch (e) {
                    console.error(`Error crítico al cargar ${file}:`, e);

                    // Proporcionar información detallada del error
                    const errorMsg = `No se pudo cargar ${pieceName}: ${e.message}. URL: ${pieceUrl}`;
                    updateLoadingText(errorMsg);

                    throw new Error(errorMsg);
                }
            }

            loadStatus.pieces = true;
        }

        // --- Función de verificación de archivos ---
        async function verifyFileExistence() {
            const filesToCheck = [
                './TMChess3D/Objects/Pieces/AbstractPiece.js',
                './TMChess3D/Objects/Pieces/Pawn.js',
                './TMChess3D/Objects/Pieces/King.js',
                './TMChess3D/Objects/Pieces/Queen.js',
                './TMChess3D/Objects/Pieces/Knight.js',
                './TMChess3D/Objects/Pieces/Rook.js',
                './TMChess3D/Objects/Pieces/Bishop.js',
                './TMChess3D/Objects/Pieces/Materials/MaterialSetLibrary.js',
                './TMChess3D/Objects/Pieces/Materials/MaterialSet.js'
            ];

            console.log("=== VERIFICACIÓN DE ARCHIVOS ===");
            for (const file of filesToCheck) {
                const fullUrl = new URL(file, location.href).href;
                try {
                    const response = await fetch(fullUrl, { method: 'HEAD' });
                    if (response.ok) {
                        console.log(`✅ ${file} existe (${response.status})`);
                    } else {
                        console.log(`❌ ${file} no existe (${response.status})`);
                    }
                } catch (e) {
                    console.log(`❌ ${file} error: ${e.message}`);
                }
            }
            console.log("=== FIN VERIFICACIÓN ===");
        }

        // --- Cargar el resto de módulos y montar la escena ---
        async function loadChessGame() {
            try {
                if (!webglAvailable()) {
                    throw new Error('WebGL no disponible en este navegador');
                }

                // Verificar archivos primero
                await verifyFileExistence();

                // THREE.js
                updateLoadingText("Cargando THREE.js...");
                try {
                    const threeUrl = new URL('./TMChess3D/libs/three.module.js', location.href).href;
                    window.THREE = await loadModule(threeUrl, 'THREE');
                    window.THREE = window.THREE.default || window.THREE;
                    loadStatus.three = true;
                    updateProgress();
                } catch (e) {
                    console.error('Error THREE:', e);
                    throw new Error('Three.js no se pudo cargar: ' + e.message);
                }

                // TWEEN.js
                updateLoadingText("Cargando TWEEN.js...");
                try {
                    const tweenUrl = new URL('./TMChess3D/libs/tween.module.js', location.href).href;
                    window.TWEEN = await loadModule(tweenUrl, 'TWEEN');
                    window.TWEEN = window.TWEEN.default || window.TWEEN;
                    loadStatus.tween = true;
                    updateProgress();
                } catch (e) {
                    console.error('Error TWEEN:', e);
                    throw new Error('TWEEN.js no se pudo cargar: ' + e.message);
                }

                // ChessGame
                updateLoadingText("Cargando ChessGame...");
                try {
                    const cgUrl = new URL('./TMChess3D/our_libs/chess/game_handler.js', location.href).href;
                    const CGmod = await loadModule(cgUrl, 'ChessGame');
                    window.ChessGame = CGmod.ChessGame || CGmod.default || CGmod;
                    loadStatus.chessGame = true;
                    updateProgress();
                } catch (e) {
                    console.error('Error ChessGame:', e);
                    throw new Error('ChessGame no se pudo cargar: ' + e.message);
                }

                // Board
                updateLoadingText("Cargando Board...");
                try {
                    const boardUrl = new URL('./TMChess3D/Objects/Board.js', location.href).href;
                    const Bmod = await loadModule(boardUrl, 'Board');
                    window.Board = Bmod.Board || Bmod.default || Bmod;
                    loadStatus.board = true;
                    updateProgress();
                } catch (e) {
                    console.error('Error Board:', e);
                    throw new Error('Board no se pudo cargar: ' + e.message);
                }

                // Pieces: primero intentar AllPieces, si falla cargar individualmente
                updateLoadingText("Cargando Pieces...");
                try {
                    const allPiecesUrl = new URL('./TMChess3D/Objects/Pieces/AllPieces.js', location.href).href;
                    const Pmod = await loadModule(allPiecesUrl, 'AllPieces');
                    window.Pieces = Pmod.Pieces || Pmod.default || Pmod;
                    loadStatus.pieces = true;
                    updateProgress();
                } catch (firstErr) {
                    console.warn('AllPieces falla, intentando piezas individuales:', firstErr);
                    await loadPiecesIndividually();
                }

                // Material sets
                updateLoadingText("Cargando MaterialSets...");
                try {
                    const matUrl = new URL('./TMChess3D/Objects/Pieces/Materials/MaterialSetLibrary.js', location.href).href;
                    const Mmod = await loadModule(matUrl, 'MaterialSets');
                    window.PiceMaterialSets = Mmod.MaterialSetLibrary || Mmod.default || Mmod;
                    loadStatus.materialSets = true;
                    updateProgress();
                } catch (e) {
                    console.error('Error MaterialSets:', e);
                    throw new Error('MaterialSets no se pudo cargar: ' + e.message);
                }

                // Loaders opcionales
                try {
                    updateLoadingText("Cargando MTLLoader (opcional)...");
                    const mtlUrl = new URL('./TMChess3D/libs/MTLLoader.js', location.href).href;
                    const MTLmod = await loadModule(mtlUrl, 'MTLLoader');
                    window.MTLLoader = MTLmod.MTLLoader || MTLmod.default || MTLmod;
                } catch (e) {
                    console.warn("MTLLoader no disponible (opcional):", e);
                }

                try {
                    updateLoadingText("Cargando OBJLoader (opcional)...");
                    const objUrl = new URL('./TMChess3D/libs/OBJLoader.js', location.href).href;
                    const OBJmod = await loadModule(objUrl, 'OBJLoader');
                    window.OBJLoader = OBJmod.OBJLoader || OBJmod.default || OBJmod;
                } catch (e) {
                    console.warn("OBJLoader no disponible (opcional):", e);
                }

                // Scene
                updateLoadingText("Cargando Scene...");
                try {
                    const sceneUrl = new URL('./TMChess3D/Scene.js', location.href).href;
                    const SceneModule = await loadModule(sceneUrl, 'Scene');
                    const SceneObj = SceneModule.MyScene || SceneModule.default || SceneModule;
                    loadStatus.scene = true;
                    updateProgress();

                    // Inicializar la escena
                    initializeScene(SceneObj);
                } catch (e) {
                    console.error('Error Scene:', e);
                    throw new Error('Scene no se pudo cargar: ' + e.message);
                }

                // Todo cargado: ocultar loading
                document.getElementById('loading').style.display = 'none';
                updateLoadingText("Carga completada");
                console.log('Todos los módulos cargados correctamente');

            } catch (error) {
                console.error('Error crítico al cargar el juego:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';

                const errorDetails = document.getElementById('error-details');
                if (errorDetails) {
                    errorDetails.innerHTML = `
                        <strong>Detalles del error:</strong><br>
                        ${error.message}<br><br>
                        <strong>Estado de carga:</strong><br>
                        <pre>${JSON.stringify(loadStatus, null, 2)}</pre>
                    `;
                }

                document.getElementById('debug-panel').style.display = 'block';
                updateDebugInfo();
            }
        }

        // Inicializar la escena (recibe la clase/constructor o módulo con MyScene)
        function initializeScene(SceneModule) {
            try {
                updateLoadingText("Inicializando escena...");

                // Verificar módulos necesarios
                const required = ['THREE','TWEEN','ChessGame','Board','Pieces','AbstractPiece'];
                for (const r of required) {
                    if (!window[r]) {
                        throw new Error(`Módulo requerido ${r} no disponible`);
                    }
                }

                // SceneModule puede ser clase o un objeto con MyScene
                const SceneConstructor = SceneModule.MyScene || SceneModule;
                const scene = new SceneConstructor("#chessCanvas");

                // Event listeners
                window.addEventListener("resize", () => scene.onWindowResize && scene.onWindowResize());
                window.addEventListener("click", () => scene.onClick && scene.onClick());
                window.addEventListener("mousemove", (ev) => scene.onMouseMove && scene.onMouseMove(ev));
                window.addEventListener("keydown", (ev) => scene.onKeyDown && scene.onKeyDown(ev));

                // Start render loop if existe update()
                if (scene.update) scene.update();

                console.log('Escena inicializada correctamente');
                updateLoadingText("Escena inicializada correctamente");
            } catch (e) {
                console.error('Error al inicializar la escena:', e);
                throw new Error('Error al inicializar la escena: ' + e.message);
            }
        }

        // Inicio cuando DOM listo
        document.addEventListener('DOMContentLoaded', () => {
            if (!webglAvailable()) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML =
                    '<p>Tu navegador no soporta WebGL, que es necesario para este juego.</p>' +
                    '<p>Por favor, actualiza tu navegador o usa uno más moderno como Chrome, Firefox o Edge.</p>';
                return;
            }

            document.getElementById('debug-panel').style.display = 'block';
            updateDebugInfo();

            // Lanzar carga principal
            loadChessGame();
        });

        // ----------------- helpers no-module -----------------
        function retryLoad() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-details').textContent = '';
            document.getElementById('progress-bar-inner').style.width = '0%';
            loadedModules = 0;
            // Recargar la página (asegura re-ejecución)
            location.reload();
        }

        function toggleDebug() {
            const dp = document.getElementById('debug-panel');
            dp.style.display = dp.style.display === 'block' ? 'none' : 'block';
            updateDebugInfo();
        }

        function webglAvailable() {
            try {
                const canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext &&
                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
            } catch (e) {
                return false;
            }
        }
    </script>

    <!-- script adicional (no module) para botones/funciones auxiliares -->
    <script>
        // este script es deliberadamente simple y no usa import()
        // retryLoad y toggleDebug ya están definidos en el módulo superior y
        // son accesibles en window por ser funciones globales (gracias al entorno).
    </script>
</body>
</html>
